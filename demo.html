<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firebase Leaderboard Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .tab-indicator {
        transition: transform 0.3s ease, width 0.3s ease;
      }
    </style>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        orderBy,
        limit,
        where,
        writeBatch
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

      const firebaseConfig = {
        //Given in env
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      function showMessage(msg, type = "success") {
        const box = document.getElementById("messageBox");
        const closeBtn = document.getElementById("closeMessage");

        box.querySelector("span").textContent = msg;
        box.className =
          "flex items-center justify-between mb-4 px-4 py-2 rounded-lg text-sm font-medium " +
          (type === "success"
            ? "bg-green-100 text-green-800 border border-green-300"
            : "bg-red-100 text-red-800 border border-red-300");

        box.classList.remove("hidden");

        setTimeout(() => {
          box.classList.add("hidden");
        }, 5000);

        closeBtn.onclick = () => box.classList.add("hidden");
      }

      async function signup() {
        const email = document.getElementById("email").value;
        const pass = document.getElementById("pass").value;
        try {
          await createUserWithEmailAndPassword(auth, email, pass);
          showMessage("Account created successfully!", "success");
        } catch (err) {
          if (err.code === "auth/email-already-in-use")
            showMessage("Email already in use. Try logging in.", "error");
          else if (err.code === "auth/invalid-email")
            showMessage("Invalid email address.", "error");
          else if (err.code === "auth/weak-password")
            showMessage("Password should be at least 6 characters.", "error");
          else showMessage(err.message, "error");
        }
      }

      async function login() {
        const email = document.getElementById("email").value;
        const pass = document.getElementById("pass").value;
        try {
          await signInWithEmailAndPassword(auth, email, pass);
          showMessage("Logged in successfully!", "success");
        } catch (err) {
          if (err.code === "auth/user-not-found")
            showMessage("No account found with this email.", "error");
          else if (err.code === "auth/wrong-password")
            showMessage("Incorrect password.", "error");
          else if (err.code === "auth/invalid-email")
            showMessage("Invalid email address.", "error");
          else showMessage(err.message, "error");
        }
      }

      async function logout() {
        await signOut(auth);
        showMessage("Logged out successfully!", "success");
      }

      async function deleteAccount() {
        const user = auth.currentUser;
        if (!user) return showMessage("No user logged in.", "error");

        if (!confirm("Are you sure? This will delete your account and all your scores."))
          return;

        try {
          const scoresRef = collection(db, "scores");
          const q = query(scoresRef, where("uid", "==", user.uid));
          const snap = await getDocs(q);

          const batch = writeBatch(db);
          snap.forEach((doc) => {
            batch.delete(doc.ref);
          });
          await batch.commit();

          await user.delete();
          showMessage("Account and scores deleted successfully.", "success");
        } catch (err) {
          if (err.code === "auth/requires-recent-login") {
            showMessage("Please log in again to delete your account.", "error");
          } else {
            showMessage(err.message, "error");
          }
        }
      }

      async function addScore() {
        const score = parseInt(document.getElementById("score").value);
        const user = auth.currentUser;
        if (!user) return showMessage("Login first!", "error");
        try {
          await addDoc(collection(db, "scores"), {
            uid: user.uid,
            email: user.email,
            score: score,
          });
          showMessage("Score submitted!", "success");
        } catch {
          showMessage("Failed to submit score.", "error");
        }
      }

      async function showLeaderboard() {
        try {
          const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(10));
          const snap = await getDocs(q);
          const list = document.getElementById("leaderboard");
          list.innerHTML = "";
          snap.forEach((doc) => {
            const d = doc.data();
            list.innerHTML += `
              <li class="py-2 px-3 border-b border-gray-200 flex justify-between">
                <span>${d.email}</span>
                <span class="font-semibold">${d.score}</span>
              </li>`;
          });
          showMessage("Leaderboard loaded!", "success");
        } catch {
          showMessage("Failed to load leaderboard.", "error");
        }
      }

      function switchTab(tab, idx) {
        document.getElementById("authTab").classList.add("hidden");
        document.getElementById("leaderboardTab").classList.add("hidden");
        document.getElementById(tab).classList.remove("hidden");

        const indicator = document.getElementById("tabIndicator");
        const tabs = document.querySelectorAll(".tab-btn");
        const active = tabs[idx];
        indicator.style.width = active.offsetWidth + "px";
        indicator.style.transform = `translateX(${active.offsetLeft}px)`;
      }

      window.switchTab = switchTab;
      window.signup = signup;
      window.login = login;
      window.logout = logout;
      window.addScore = addScore;
      window.showLeaderboard = showLeaderboard;
      window.deleteAccount = deleteAccount;

      onAuthStateChanged(auth, (user) => {
        const userInfo = document.getElementById("userInfo");
        const logoutBtn = document.getElementById("logoutBtn");
        const deleteBtn = document.getElementById("deleteAccountBtn");

        if (user) {
          userInfo.textContent = `Logged in as: ${user.email}`;
          logoutBtn.classList.remove("hidden");
          deleteBtn.classList.remove("hidden");
        } else {
          userInfo.textContent = "Not logged in";
          logoutBtn.classList.add("hidden");
          deleteBtn.classList.add("hidden");
        }
      });

      window.addEventListener("load", () => switchTab("authTab", 0));
    </script>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col items-center">
    <!-- Navbar -->
    <nav class="w-full bg-indigo-600 text-white px-6 py-3 flex justify-between items-center shadow-md">
      <span class="font-semibold text-lg">ðŸ”¥ Firebase Leaderboard</span>
      <div class="flex items-center space-x-4">
        <span id="userInfo" class="text-sm opacity-90">Not logged in</span>
        <button id="logoutBtn" onclick="logout()" class="hidden px-3 py-1 bg-red-500 hover:bg-red-600 rounded-lg text-sm shadow">Logout</button>
        <button id="deleteAccountBtn" onclick="deleteAccount()" class="hidden px-3 py-1 bg-red-700 hover:bg-red-800 rounded-lg text-sm shadow">Delete Account</button>
      </div>
    </nav>

    <div class="w-full max-w-md bg-white shadow-lg rounded-2xl overflow-hidden mt-6">
      <!-- Tabs -->
      <div class="relative border-b border-gray-200 flex">
        <button class="w-1/2 py-3 text-center font-medium hover:bg-gray-100 tab-btn" onclick="switchTab('authTab', 0)">Authentication</button>
        <button class="w-1/2 py-3 text-center font-medium hover:bg-gray-100 tab-btn" onclick="switchTab('leaderboardTab', 1)">Leaderboard</button>
        <div id="tabIndicator" class="absolute bottom-0 h-1 bg-indigo-600 rounded-full tab-indicator"></div>
      </div>

      <!-- Message Box -->
      <div id="messageBox" class="hidden px-4 py-2 mb-4 rounded-lg text-sm flex justify-between items-center">
        <span></span>
        <button id="closeMessage" class="ml-2 text-lg leading-none">&times;</button>
      </div>

      <!-- Auth Tab -->
      <div id="authTab" class="p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Login / Signup</h2>
        <input id="email" placeholder="Email" class="w-full mb-3 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        <input id="pass" type="password" placeholder="Password" class="w-full mb-4 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        <div class="flex justify-between">
          <button onclick="signup()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700">Signup</button>
          <button onclick="login()" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700">Login</button>
        </div>
      </div>

      <!-- Leaderboard Tab -->
      <div id="leaderboardTab" class="hidden p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Leaderboard</h2>
        <div class="mb-4">
          <input id="score" type="number" placeholder="Enter your score" class="w-full mb-3 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <button onclick="addScore()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700">Submit Score</button>
        </div>
        <button onclick="showLeaderboard()" class="w-full mb-3 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Load Leaderboard</button>
        <ul id="leaderboard" class="divide-y divide-gray-200 bg-gray-50 rounded-lg"></ul>
      </div>
    </div>
  </body>
</html>
